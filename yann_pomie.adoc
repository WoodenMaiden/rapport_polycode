:version: unknown
= Document d'architecture technique
Yann POMIE <yann.pomie@etu.umontpellier.fr>
commit {version}, 02-11-2022
:toc:
:homepage: https://polycode.do-2021.fr/
:source-highlighter: highlight.js
:sectanchors: true
:cache-uri: true
:allow-uri-read: true

:img: ./images
:imgcode: {img}/code_editor
:figmalink: https://www.figma.com/file/iNqVl5HUfEIAcHHNQP9Ml8/Polycode-Phone-version?t=dm0CmVkwWiQZ0r3R-1 
:navlink: https://www.figma.com/proto/iNqVl5HUfEIAcHHNQP9Ml8/Polycode-Phone-version?node-id=504%3A572&scaling=scale-down&page-id=0%3A1&starting-point-node-id=504%3A572

:profile-flow: https://www.figma.com/proto/iNqVl5HUfEIAcHHNQP9Ml8/Polycode-Phone-version?node-id=16%3A2075&scaling=scale-down&page-id=0%3A1&starting-point-node-id=16%3A2075&show-proto-sidebar=1
:team-flow: https://www.figma.com/proto/iNqVl5HUfEIAcHHNQP9Ml8/Polycode-Phone-version?node-id=603%3A571&scaling=scale-down&page-id=0%3A1&starting-point-node-id=603%3A571&show-proto-sidebar=1
:module-flow: https://www.figma.com/proto/iNqVl5HUfEIAcHHNQP9Ml8/Polycode-Phone-version?node-id=614%3A1098&scaling=scale-down&page-id=0%3A1&starting-point-node-id=614%3A1098&show-proto-sidebar=1
:search-flow: https://www.figma.com/proto/iNqVl5HUfEIAcHHNQP9Ml8/Polycode-Phone-version?node-id=644%3A1153&scaling=scale-down&page-id=0%3A1&starting-point-node-id=644%3A1153&show-proto-sidebar=1
:404-flow: https://www.figma.com/proto/iNqVl5HUfEIAcHHNQP9Ml8/Polycode-Phone-version?node-id=644%3A1268&scaling=scale-down&page-id=0%3A1&starting-point-node-id=644%3A1268&show-proto-sidebar=1
:assessment-flow: https://www.figma.com/proto/iNqVl5HUfEIAcHHNQP9Ml8/Polycode-Phone-version?node-id=644%3A1304&scaling=scale-down&page-id=0%3A1&starting-point-node-id=644%3A1304&show-proto-sidebar=1

:i: includes
:swagger-file: {i}/swagger.html
:swagger-url: https://woodenmaiden.github.io/rapport_polycode_swagger


<<<
== Q1: En partant des pr√©-requis, que proposez-vous comme s√©paration en quartiers fonctionnels de votre application et en termes de micro-services?

=== Vocabulaire m√©tier et user stories
Suite √† de nombreuses incompr√©hensions, nous avons red√©fini une grande partie du vocabulaire m√©tier, nous en avons aussi profit√© pour red√©finir nos user stories. 

Voici les d√©finitions du vocabulaire m√©tier que vous serez succesptible de trouver dans nos user stories et dans le reste du document.

* *Invit√©* : Client n'ayant pas de compte sur la plateforme 
* *Utilisateur* : Client ayant un compte sur la plateforme
* *Administrateur* : Utililisateur privil√©gi√© ayant des droits CRUD sur toutes les ressources de la plateforme
* *√âquipe* : Regroupement d'utilisateurs compos√© d'un capitaine et de membres
* *√âvaluation* : Une √©valuation destin√©e √† des utilisateurs
* *Test* : Il s'agit d'un groupe ordonn√© de contenus, not√©, con√ßu pour √©valuer les utilisateurs. Il est cr√©√© par un cr√©ateur d'√©valuation.
* *Candidat* : Utilisateur participant √† une √©valuation ou a un test
* *Campagne de tests* : exposition d'un groupe utilisateurs √† un test
* *Composant* : √âl√©m√©nt affich√© √† l'utilisateur, il peut s'agir de markdown, d'un √©diteur de code etc...
* *Contenu* : Ensemble coh√©rent de composants
* *Module* : Un groupement de contenus, peut √©galement contenir d'autres modules appel√©s sous-modules 
* *PolyPoints* : Points gagn√©s par les utilisateurs lorsqu'ils r√©ussissent des d√©fis de composant
* *Validateur* : √âl√©ment cach√© de l'utilisateur, associ√© √† un composant, il permet de v√©rifier la validit√© des r√©ponses de l'utilisateur et r√©compense les bonnes r√©ponses avec des PolyPoints.

[cols="1,2,2"]
|===
|En tant que...|Je veux...|Afin de...

|Invit√©
|Cr√©er un compte
|D'utiliser l'application

|Invit√©
|Cr√©er un compte avec un compte Google/Polytech
|D'utiliser l'application sans avoir √† cr√©er un mot de passe et sans avoir √† saisir mes informations personnelles

|Utilisateur
|Mettre √† jour mes adresses mails 
|Pour r√©cup√©rer mon compte en cas de perte de mot de passe ou en cas de probl√®mes d'email

|Utilisateur
|Recevoir un mail lors de bienvenue apr√®s inscription
|√ätre averti que mon inscription √† bien √©t√© faite

|Utilisateur
|Changer mon nom, mon mot de passe, mon language de programmation et ma bio
|Mes informations personelles soient √† jour

|Utilisateur 
|Delete my account 
|Ne plus avoir de trace sur l‚Äôapplication 

|Utilisateur 
|Me connecter gr√¢ce une adresse mail et un mot de passe/gr√¢ce √† un compte Google ou Polytech
|Je puisse acc√®der √† toutes les fonctionnalit√©s de l‚Äôapplication 

|Utilisateur 
|Me d√©connecter de mon compte
|√âviter les acc√®s non autoris√©s depuis le navigateur utils√©. 

|Utilisateur 
|R√©cup√©rer mon mot de passe via un mail
|Je puisse r√©cup√©rer mon compte en cas de perte de mon mot de passe

|Utilisateur 
|Cr√©er une nouvelle √©quipe
|R√©unir un groupe d‚Äôutilisateurs et parciper au leaderboard des √©quipes (somme des points de chaque utilisateur).

|Capitaine 
|Invite d'autres utilisateurs √† √™tre membre de mon √©quipe
|Mon √©quipe s‚Äôagrandisse

|Capitaine
|Exclure un membre de mon √©quipe
|Enlever un membre probl√©matique / non actif / qui n‚Äôest plus en ad√©quation avec le groupe.

|Capitaine 
|Donner le r√¥le de capitaine √† un autre membre de mon √©quipe
|Je sois dispos√© de ces fonctions

|Capitaine
|Supprimer mon √©quipe
|Ne plus avoir de traces de cette √©quipe, pour quelconque raison. 

|Capitaine 
|Changer le nom et la description de mon √©quipe 
|Les informations de l‚Äô√©quipe reste √† jour

|Utilisateur
|Accepter ou d√©cliner une invitation √† une √©quipe 
|Ajoute les PolyPoints (pr√©c√©dents) et gagn√©s de l‚Äôutilisateur √† l‚Äô√©quipe

|Utilisateur 
|Pouvoir quitter une √©quipe
|Je ne sois plus associ√© √† un groupe d‚Äôutilisateur

|Utilisateur
|Voir les points de mon √©quipe
|Constater l‚Äôavancement des membres de l'√©quipe

|Utilisateur
|Voir le classement des √©quipes
|Je vois le placement de mon √©quipe vis-√†-vis des autres 

|Utilisateur
|Voir le classement interne des membres de l‚Äô√©quipe
|Voir qui a particip√© le plus dans l‚Äô√©quipe, concurrence interne

|Utilisateur
|Voir la liste des exercices disponibles
|Je puisse choisir un exercice √† faire 

|Utilisateur
|Voir la liste des modules disponibles
|Je puisse choisir un module √† faire 

|Utilisateur
|Voir les sous-modules et les exercices d‚Äôun module 
|Trouver les √©tapes √† faire pour compl√©ter le module

|Utilisateur 
|Voir la liste des √©valuations disponibles 
|Je puisse choisir une √©valuation √† passer 

|Utilisateur 
|Voir les derniers exercices / modules mis en ligne
|Voir le nouveau contenu 

|Utilisateur 
|Voir les informations d‚Äôun exercice 
|M‚Äôinformer sur le sujet d‚Äôun exercice 

|Utilisateur 
|Voir les informations d‚Äôun module 
|M‚Äôinformer sur le sujet du module, l‚Äôobjectif 

|Utilisateur 
|Voir les informations d‚Äôune √©valuation
|M‚Äôinformer sur le sujet de l‚Äô√©valuation, l‚Äôobjectif 

|Utilisateur 
|Voir l‚Äô√©nonc√© d‚Äôun exercice 
|D'apprendre une nouvelle notion, conna√Ætre le probl√®me √† r√©soudre, question √† r√©pondre pour valider la notion  

|Utilisateur 
|Proposer une solution √† l‚Äôexercice 
|Gagner des PolyPoints et avancer dans le module associ√© 

|Utilisateur 
|Dans le cas d‚Äôun code √† √©crire, ex√©cuter un validateur interm√©diaire  
|V√©rifier si mon code est correct pour le validateur en question 

|Utilisateur 
|Revoir la derni√®re solution qui √† pass√©e le plus de validateurs 
|Reprendre le code depuis un appareil diff√©rent, √† un autre moment, pour l‚Äôam√©liorer 

|Utilisateur 
|√âcrire (et modifier) sa solution de code dans un √©diteur int√©gr√© √† la page de l‚Äôexercice 
|Proposer une solution √† l‚Äôexercice 

|Utilisateur 
|Ajouter des fichiers dans l‚Äô√©diteur int√©gr√© √† la page d‚Äôexercice
|Organiser la solution en plusieurs fichiers 

|Utilisateur 
|Supprimer des fichiers dans l‚Äô√©diteur 
|Organiser la solution en plusieurs fichiers 

|Utilisateur 
|Afficher les donn√©es de validateur (entr√©e et sortie) en √©change de avec des PolyPoints
|Comprendre mieux comment r√©soudre l‚Äôexercice 

|Utilisateur 
|Suivre ma progression dans chacun des modules 
|Voir ce qui est compl√©t√© / √† faire  

|Utilisateur 
|Voir le classement global des utilisateurs (par polypoints) 
|Nous motiver √† atteindre le sommet (principe de concurrence) 

|Utilisateur 
|Passer une √©valuation 
|Obtenir une certification 

|Utilisateur 
|Lire le contenu d‚Äôun cours 
|Monter en comp√©tence sur un sujet 

|Cr√©ateur de contenu 
|Cr√©er un exercice 
|Proposer l‚Äôapprentissage d‚Äôune nouvelle notion, faire v√©rifier la connaissance de cette notion par une question/ un code √† √©crire 

|Cr√©ateur de contenu 
|Cr√©er un module 
|Organiser les exercices par notion majeure / th√©matique 

|Cr√©ateur d'√©valuation 
|Cr√©er une √©valuation 
|V√©rifier les comp√©tence d‚Äôun utilisateur sur un contenu 

|Cr√©ateur de contenu 
|Ajouter ses exercices √† un module qu‚Äôil a cr√©√© 
|Remplir le contenu d‚Äôun module en ensemble d‚Äô√©l√©ment coh√©rent 

|Cr√©ateur de contenu 
|Ajouter des modules dans un module, et ce avec des modules qu‚Äôil a cr√©√© (sous-module) 
|Remplir le contenu d‚Äôun module en ensemble d‚Äô√©l√©ment coh√©rent 

|Cr√©ateur de contenu 
|Modifier le nom, la description, le nombre de PolyPoints de r√©compense, les tags, le contenu (exercices et sous-module) de ses modules 
|Garder √† jour un module 

|Cr√©ateur de contenu 
|Modifier le titre, la description, le contenu, r√©compense en polypoints,  les validateurs, les tags d‚Äôun exercice 
|Garder √† jour un exercice 

|Cr√©ateur de contenu 
|Modifier le titre, la description, le contenu d‚Äôune √©valuation
|Garder √† jour une √©valuation 

|Cr√©ateur de contenu 
|Supprimer un exercice qu‚Äôil a cr√©√© 
|R√©parer une erreur / ne plus vouloir la pr√©sence de ce contenu 

|Cr√©ateur de contenu 
|Supprimer un module qu‚Äôil a cr√©√© 
|R√©parer une erreur / ne plus vouloir la pr√©sence de ce contenu 

|Cr√©ateur de contenu
|Supprimer une √©valuation qu‚Äôil a cr√©√©
|R√©parer une erreur / ne plus vouloir la pr√©sence de ce contenu 

|Cr√©ateur de contenu
|Voir le r√©sultat des utilisateurs sur une √©valuation qu‚Äôil a cr√©√©
|Pour que le recruteur / professeur voie le r√©sultat des √©l√®ves pour attribuer une note / recruter 

|Administrateur
|Promouvoir un utilisateur en r√©dacteur
|Qu‚Äôun utilisateur ai les droits d‚Äôun ‚Äúredacteur‚Äù 

|Administrateur
|Promouvoir un utilisateur en Administrateur
|Qu‚Äôun utilisateur ai les droits d‚Äôun ‚ÄúAdministrateur‚Äù 

|Administrateur
|Cr√©er un utilisateur
|Utiliser l‚Äôapplication avec un autre compte 

|Administrateur
|R√©cup√©rer les donn√©es d‚Äôun utilisateur
|Voir les informations confidentielles d‚Äôun compte utilisateur 

|Administrateur
|Mettre √† jour les donn√©es d‚Äôun utilisateur
|Mettre √† jour les informations personnelles afin qu‚Äôelles soient coh√©rentes 

|Administrateur
|Supprimer un utilisateur
|Ne plus donner acc√®s √† la plateforme pour un compte utilisateur 

|Administrateur
|Cr√©er un exercice
|Proposer l‚Äôapprentissage d‚Äôune nouvelle notion, faire v√©rifier la connaissance de cette notion par une question/ un code √† √©crire 

|Administrateur
|Modifier le titre, la description, le contenu, r√©compense en polypoints,  les validateurs, les tags d‚Äôun exercice
|Garder √† jour un exercice 

|Administrateur
|Supprimer un exercice
|R√©parer une erreur / ne plus vouloir la pr√©sence de ce contenu 

|Administrateur
|Cr√©er un module
|Cr√©er un module afin de regrouper des contenus 

|Administrateur
|R√©cup√©rer les donn√©es d‚Äôun module
|Voir les informations et les contenus associ√©s √† ce module 

|Administrateur
|Mettre √† jour les donn√©es d‚Äôun module
|Garde le module √† jour 

|Administrateur
|Supprimer un module
|Effacer les traces du module sur la plateforme 

|Administrateur
|Cr√©er une √©valuation
|V√©rifier les comp√©tence d‚Äôun utilisateur sur un contenu 

|Administrateur
|R√©cup√©rer les donn√©es d‚Äôune √©valuation
|Voir les diff√©rentes donn√©es en lien avec une √©valuation 

|Administrateur
|Mettre √† jour les donn√©es d‚Äôune √©valuation
|Ajouter des utilisateurs ou modifier des donn√©es relatives √† une √©valuation 

|Administrateur
|Supprimer une √©valuation
|Enlever une √©valuation de la plateforme 

|Administrateur
|Cr√©er une team
|Rassembler des utilisateurs dans une √©quipe 

|Administrateur
|Ajouter un membre dans mon √©quipe
|Proposer √† un utilisateur de rejoindre mon √©quipe 

|Administrateur
|Supprimer un membre d‚Äôune team
|Enlever un utilisateur de mon √©quipe pour une quelconque raison 

|Administrateur
|Supprimer une team
|Supprimer une team qui ne valide pas les conditions d‚Äôutilisation 

|Administrateur
|Modifier la description d‚Äôune √©quipe
|Avoir une description √† jour de l‚Äô√©quipe 

|Cr√©ateur d'√©valuation
|Cr√©er une campagne de test
|Evaluer le niveau des utilisateurs 

|Cr√©ateur d'√©valuation
|Ajouter des utilisateurs √† ma campagne via une interface web
|Faire participer les candidats 

|Cr√©ateur d'√©valuation
|Supprimer des utilisateurs √† ma campagne via une interface web
|Enlever un candidat des participants 

|Cr√©ateur d'√©valuation
|Ajouter des utilisateurs √† ma campagne via des appels API
|Faire participer les candidats 

|Cr√©ateur d'√©valuation
|Supprimer des utilisateurs √† ma campagne via des appels API
|Enlever un candidat des participants 

|Cr√©ateur d'√©valuation
|Ajouter des utilisateurs √† ma campagne via l‚Äôimportation de fichiers csv
|Faire participer les candidats 

|Cr√©ateur d'√©valuation
|Voir les r√©sultats et statistiques sur la campagne que j‚Äôai cr√©√©
|Me rendre compte du niveau des candidats test√©s 

|Cr√©ateur d'√©valuation
|Ajouter des tags √† mes candidats
|Grouper les candidats 

|Cr√©ateur d'√©valuation
|D√©finir une date limite pour ma campagne
|Cl√¥turer ma campagne √† une date fixe 

|Candidat
|Revenir sur un test et reprendre l√† o√π j‚Äôen √©tait
|Finir mon test si jamais je quitte l‚Äôapplication 

|Cr√©ateur d'√©valuation
|D√©finir un temps limite pour chaque question de ma campagne
|Les candidats r√©pondent dans un temps limit√© 

|Cr√©ateur d'√©valuation
|D√©finir un nb de points pour chaque question
|Avoir un score par candidats et voir leur diff√©rence de score √† la fin de la campagne 

|Candidat
|Recevoir un mail me permettant de participer √† une campagne de tests
|Avoir un lien pour participer √† une campagne 

|Candidat 
|Accepter de participer √† une campagne 
|Tester ses comp√©tences √† travers une campagne 

|Candidat 
|Refuser de participer √† une campagne 
|Avoir la possibilit√© de refuser une campagne et que le cr√©ateur en soit inform√© 

|Cr√©ateur d'√©valuation 
|√âditer ma campagne, les tests li√©s 
|Modifier une campagne pr√©c√©demment cr√©√©e 

|Cr√©ateur d'√©valuation 
|D√©finir une date de d√©but de ma campagne 
|D√©finir une date pour les candidats, ainsi qu‚Äôun temps imparti pour finaliser la campagne 

|Cr√©ateur d'√©valuation 
|Envoyer des liens de ma campagne manuellement √† mes candidats 
|S‚Äôassurer que les candidats re√ßoivent bien le lien pour participer √† une campagne 

|Candidat 
|Recevoir un mail de confirmation contenant des stats quand j‚Äôai soumis mon test 
|Notifier l‚Äôutilisateur que sa participation et ses r√©ponses ont bien √©t√© enregistr√©es pour une campagne 

|Cr√©ateur d'√©valuation 
|Voir le nombre de points totaux par candidats 
|Comparer les points des candidats ayant particip√© √† la campagne 

|Cr√©ateur d'√©valuation 
|Visualiser un graphique/un excel par tags de content et par candidats 
|Voir graphiquement les diff√©rents r√©sultats 

|Cr√©ateur d'√©valuation 
|Exporter les resultats synthetis√©s dans un pdf 
|Sauvegarder les r√©sultats des candidats et avoir une vue synth√©tique 

|Cr√©ateur d'√©valuation 
|Exporter les resultats d√©taill√©s dans un pdf 
|Sauvegarder les r√©sultats des candidats et y avoir acc√®s sans passer par l‚Äôapplication 

|Cr√©ateur d'√©valuation 
|Avoir une vue comparative des candidats sous la forme d‚Äôun tableau excel 
|Comparer les score des candidats √† travers un tableau 

|Cr√©ateur d'√©valuation 
|Trier la liste des candidats par tags, resultats 
|Comparer les r√©sultats des candidats en fonction de donn√©es pr√©cises 

|Cr√©ateur d'√©valuation 
|T√©l√©charger les scores des candidats 
|Afin de garder les stats en local 
|===

=== D√©coupage en quartier fonctionnels
En consid√©rant ces users stories on peut en d√©duire ces quartiers fonctionnels :

. Authentification/Authorisation : permet √† l'utilisateur de s'inscrire et de s'identifier sur la plateforme. V√©rifie les droits de l'utilisateur sur une ressource.
. Gestion des utilisateurs : permet la gestion des utilisateurs.
. Edition de modules : donne la possibilit√© d'√©diter et de visualiser des modules ainsi que leurs contenus et composants.
. Envoi de mail : envoie des mail aux utilisateurs.
. Gestion de campagne : donne la possibilit√© de la gestion des campagnes de tests.
. Gestion des runners : permet de lancer des runners afin d'√©x√©cuter du code.

.Architecture en microservices propos√©e
image::{img}/q1_architecture.png["Architecture de polycode"]

=== Justification de l'architecture

Le but premier de cette organsation est de r√©duire au maximum les d√©pendances entre chaque service notament au niveau des canneaux de communications, en effet on peut remarquer que peu de services comminiquent entre eux, hormis avec Keycloak qui est crucialpour l'idententification et l'autorisation (cf. √† la question 2). Le fait de limiter le nombre de cannaux de communications permet de r√©duire les risques de d√©faillance g√©n√©rale et de faciliter la maintenance.

Le probl√®me de ce choix technique est que l'on r√©duit certes les √©ventuelles erreurs inter-services mais en cas de panne de toutes les instances keycloak, les utilisateurs ne pourront pas interagir avec l'application.

Vu que nous nous pla√ßons dans une architecture de microservices il faut partir du principe que nos services auront des r√©plicas qui vont crasher et dautres qui vont d√©marrer. Pour assurer un bon routage de nos requ√™tes, nous allons utiliser un service registery afin de garder en m√©moire nos services encore vivants ainsi que leur adresse IP (cf. <<_enregistrement_des_runners,Question 9 - Enregistrement des runners>>).


Il √† aussi √©t√© envisag√© de faire un service _√âquipe_ et _Contenu_ s√©par√©s mais cela aurait impliqu√© de faire des appels API suppl√©mentaires et donc d'encore augmenter le nombre de cannaux de communications et donc d'augmenter le temps de latence. De plus √ßa n'aurait aucun sens car les notions d'utilisateur et d'√©quipe sont interd√©pendantes et qu'un module n'a au final d'int√©r√©ssant que les contenus qu'il contient.

<<<
== Q2: Comment g√©rer le syst√®me d‚Äôauthentification avec un OIDC?

<<<
== Q3: Communication Inter micro-services

Quand nous regardons les microservices que nous avons d√©fini plus t√¥t nous pouvons remarquer que grand nombre d'entre eux devront impl√©menter un CRUD tel que le microservice des utilisateurs, des modules etc., il est donc n√©cessaire d'utiliser un protocole de communication synchrone afin de faire remonter une erreur en cas de probl√®me au niveau des bases de donn√©es. Pour ce faire ces services vont utiliser le protocole HTTP avec des endpoint REST. 

Pour les microservices qui ne sont pas des CRUD comme le microservice d'envoi de mail, il est plus int√©ressant d'utiliser un protocole de communication asynchrone. En effet, si nous prenons toujours l'example de l'envoi de mail, il est inutile de faire remonter une erreur au niveau de l'API gateway si le mail n'a pas pu √™tre envoy√©, ce dernier pouvant √™tre renvoy√©, il est pr√©f√©rable de simplement logger l'erreur et de continuer le traitement.

Dans des circonstances normale nous serions partis sur un syst√®me de message queue tel que RabbitMQ, syst√®me gr√¢ce auquel toutes les communications sont stock√©es dans une file d'attente permettant au destinataire de traiter les messages √† son rythme et de reprendre l√† o√π il en √©tait en cas de crash. Cependant le sujet nous interdit explicitement d'utiliser ce type de protocole. 

Dans un premier temps il a √©t√© envisag√© d'utiliser la technique du http long polling. Cette technique consiste √† faire de longues requ√™tes HTTP en boucle jusqu'√† ce que le serveur renvoie une r√©ponse, ce qui permet de simuler une communication asynchrone. Dans notre cas c'est le microservice d'envoi de mail qui va faire les requ√™tes HTTP jusqu'√† ce qu'une r√©ponse soit re√ßue. Cette approche est tr√®s simple conceptuellement, dependant elle pr√©sente beaucoup trop de d√©savantages pour √™tre utilis√©e. En effet un _proof of concept_ <<poc_q3_lp>> ainsi que le document RFC6202 "Known Issues and Best Practices for the Use of Long Polling and Streaming in Bidirectional HTTP" <<rfc6202>> publi√© en avril 2011, mettent en √©vidence de nombreux probl√®mes li√©s √† cette technique dont les plus importants sont: 

* Une consommation importante de ressources c√¥t√© serveur, en effet le serveur doit maintenir une connection ouverte avec le client et doit traiter les requ√™tes HTTP m√™me si aucune r√©ponse n'est attendue.
* Une certaine latence, m√™me si l'envoi de mail est un processus long, il est pr√©f√©rable de r√©duire la latence de nos processus au maximum.
* Les timeout pouvant poser probl√®me dans la mesure ou les proxys peuvent fermer la connexion avant que le serveur ne renvoie une r√©ponse.

Suite √† un deuxi√®me _proof of concept_ <<poc_q3_ws>>, une autre solution est d'utiliser des websockets pour communiquer avec ces services, en effet les websockets permettent des communications asynchrones entre nos services qui peuvent passer √† travers un proxy.
H√©las cette solution admet deux gros probl√®mes :

* Il est impossible de pour l'un des deux parties de savoir si l'autre est indisponible ce qui pose probl√®me dans un environnement en picroservice o√π tout service peut s'arr√™ter √† tout moment. Une impl√©mentation pour relancer le socket s'impose donc.  
* Les connections √©tant persistentes, un scaling horizontal est tout bonnement impossible, les deux parties devant absolument √™tre les m√™mes. 

La solution la plus simple et posant le moins de soucis reste des appels HTTP vers une API REST que notre fil d'√©x√©cution principal n'attendra pas, m√™me si cette solution est moins _fault tolerant_ qu'une message queue, elle a le m√©rite d'√™tre tr√®s simple √† imp√©menter (cf. <<poc_q3_http>>), l√† ou du RPC n√©c√©ssiterait des fichiers de d√©finition. De plus cela permet d'√©viter de faire de nos microservice des hybrides API REST/Serveur long polling ou API REST/Serveur websocket comme vous pouvez le voir dans les premiers _proof of concept_ <<poc_q3_ws>> <<poc_q3_lp>>.

Pour illustrer notre solution faisons un diagramme de s√©quence en prenant l'exemple de quelqu'un s'incrivant √† Polycode:

.Diagramme de s√©quence d'une inscription
image::{img}/q3_sequence.png["Diagramme de s√©quence d'une inscription"]


<<<
== Q4: Comment tracer les logs et les requ√™tes?

Le tra√ßage distribu√© est une m√©thode employ√©e pour suivre le parcours d'une requ√™te dans un syst√®me distribu√© comme dans le cas d'une architecure en microservices. Il permet de suivre les requ√™tes et les r√©ponses entre les diff√©rents services.

Une solution de tra√ßage distribu√© va marquer une requ√™te de l'utilisateur avec un identifiant unique et le transmettre √† chaque service qui la re√ßoit. Chaque traitement effectu√© sur la requ√™te va ajouter des informations tel que le nom du service, le temps de traitement, etc.
Zipkin est une solution qui va collecter les informations de tra√ßage et de pr√©senter les donn√©es de fa√ßon compr√©hensible. Zipkin est compos√© de 3 composants :  

* Un serveur qui va collecter les informations de tra√ßage et les stocker dans une base de donn√©es.
* Un client qui va ajouter des informations de tra√ßage √† chaque requ√™te.
* Une interface web qui va permettre de visualiser les informations de tra√ßage. 

On peut associer une base de donn√©es au serveur Zipkin pour stocker les informations de tra√ßage.

Voici l'architecture propos√©e pour l'int√©gration de Zipkin dans notre application :

.Proposition d'architecture pour l'int√©gration de Zipkin
image::{img}/q4_architecture.png["Zipkin architecture"]

Nous aurions pu utiliser Jaeger √† la place de Zipkin, cependant Zipkin supporte plus de langages.

Les logs seront stock√©s dans une base de donn√©es Elasticsearch, ses performances permettent le stockage et la lecture de nombreux logs. Malgr√© son efficacit√© nous prendrons bien soin de la placer sur un autre noeud afin que ses op√©rations ne perturbent pas d'autres pods.

Voici un diagramme de s√©quence qui illustre le fonctionnement de Zipkin et d'Elasticsearch lors d'une cr√©ation de compte :

.Diagramme de s√©quence d√©crivant la cr√©ation de compte
image::{img}/q4_sequence.png["Zipkin diagramme de s√©quence"]

Apache Kafka est utilis√© dans cette configuration pour envoyer les logs √† Zipkin, le but de cette utilisation est d'envoyer des requ√™tes de mani√®re asynchrone afin de ne pas ralentir les microservices utilisateur et d'envoi de mail, ainsi une inscription sera rapide pour l'utilisateur.

<<<
== Q5: Comment ajouter un moteur de recherche?

=== Moteur de recherche
Afin de pouvoir rechercher du texte gr√¢ce √† une barre de recherche, nous devons d'abord identifier les donn√©es pouvant √™tre sujets √† une recherche.
√Ä l'heure actuelle nous souhaitons pouvoir retrouver un exercice ou un cours √† partir du texte qu'il contient, √† l'heure actuelle les cours de Polycode sont organis√©s avec cette structure.

.Classes impliqu√©es dans la recherche
[source, typescript]
....
class Module {
    id: uuid;
    name: string; // Champ sujet √† recherche
	description: string; // Champ sujet √† recherche
	type: 'challenge' | 'practice' | 'certification' | 'submodule' | ...;
    // ...
	contents: Content[];
	modules: Module[];
	tags: string[]; // Champ sujet √† recherche
}

// ...

class Content {
	id: uuid;
	name: string; // Champ sujet √† recherche
	description: string; // Champ sujet √† recherche
	type: 'exercise' | 'lesson' | ...;
	rootComponent: Component;
    // ...
}

// ...

class Component {
    id: uuid;
	type: 'container' | 'editor' | 'quizz' | 'markdown';
	// ...
    components: Component[];
	markdown: string; // Champ sujet √† recherche
}
....

Les champs name, description, tags et markdown sont des champs sur lesquels l'utilisateur pourra effectuer des recherches full text search. Cependant pour √©viter d'avoir √† indexer plusieurs champs d'un m√™me document, le microservice module se chargera d'ins√©rer un document dans une autre base de donn√©es contenant la concat√©nation de ces champs et de l'identifiant de l'objet en question. Ce m√™me microservice se chargera aussi d'effectuer les recherches.

.Structure du document dans la base de donn√©es de recherche
[source, typescript]
....
type IndexedDocument = {
    id: uuid;
    text: string; // le texte concat√©n√©

    // ces champs ne seront jamais utilis√©s pour une recherche
    data : {
        type: 'module' | 'content' | 'component';
        name: string;
        description: string;
    };
};
....

La base de donn√©es en question sera Elasticsearch, cette derni√®re utilisant le moteur apache Lucene, il nous sera possible de faire des recherches en full text search sur le texte de chaque module, contenu et composant. Tout comme pour les logs nous placrons cette base de donn√©es sur une autre machine physique, s√©par√©e des autres services pour ne pas interf√©rer avec eux.

En cas de nouvelles attentes concernant la recherche (par exemple la recherche d'utilisateurs), il serait envisageable de cr√©er un microservice d√©di√© √† la recherche. Nous ne le cr√©erons pas pour l'instant car seuls les modules, contenus et composants sont concern√©s par la recherche et que cela violerait le principe YAGNI (You Ain't Gonna Need It)

Nous avons donc ces diagrammes de s√©quence :

.Diagramme de s√©quence d√©crivant l'indexation d'un module
image::{img}/q5_sequence_indexation.png["Diagramme de s√©quence d'une indexation"]

.Diagramme de s√©quence d√©crivant la recherche par mot cl√©
image::{img}/q5_sequence_recherche.png["Diagramme de s√©quence de la recherche"]

=== Int√©gration dans le frontend

Concernant le frontend nous pouvons imaginer une barre de recherche dans l'en-t√™te de la page. Qui une fois click√©e ouvrira une fen√™tre modale avec un champ de recherche. Cela permettra de pouvoir rechercher sans avoir √† se soucier des composants de la page.

.Proposition d'int√©gration de la barre de recherche
image::{img}/q5_ui_searchbar.png["Proposition d'int√©gration de la barre de recherche"]

.Proposition d'interface de recherche
image::{img}/q5_ui_search.png["Proposition d'interface de recherche"]

Quand l'utilisateur rentre du texte une requ√™te est envoy√©e au microservice de modules qui va renvoyer les r√©sultats. Les donn√©es contenues dans le champ ``IndexedDocument.data`` permettront de d√©tailler les r√©sultats de la recherche.

.Proposition d'interface de r√©sultats de recherche
image::{img}/q5_ui_search_results.png["Proposition d'interface de r√©sultats de recherche"]

<<<
== Q6: Comment mettre en place l‚Äôarchitecture de runner

=== D√©finition du runner

Le runner est un √©l√©ment central dans le fonctionnement de Polycode. Il s'agit d'une API √† laquelle on donne du code, un language et des param√®tres √† passer par l'entr√©e standard, elle est charg√©e de cr√©er des environnements isol√©s (conteneurs, machines virtuelles etc) qui vont se charger d'ex√©cuter le code en renvoyant le r√©sultat de l'ex√©cution sur leur sortie standard. C'est cette sortie standard qui sera compar√©e aux donn√©es du validateur pour d√©terminer si l'exercice a √©t√© r√©ussi ou non.

=== Architecture

La premi√®re chose √† laquelle on peut penser en parlant d'isolation c'est de privil√©gier la cr√©ation de machines virtuelles qui, contrairement √† ce que l'on pense, peuvent d√©marrer relativement rapidement. Ce besoin de d'isolation est important car il faut √©viter que le code de l'utilisateur puisse interf√©rer avec l' infrastructure avec d'autres processus, isolation que Docker ne peut pas garantir car les conteneurs docker sont des procesuss isol√©s avec ``iptables`` et ``cgroup``.

En plus d'une isolation du code, il faut aussi isoler le r√©seau pour emp√™cher l'utilisateur d'utiliser du code qui pourrait cibler nos services internes, c'est pour cela que nous emp√™cherons les runners d'envoyer des paquets r√©seau via un pare feu.

.Sch√©matisation du service de runner
image::{img}/q6_architecture_service.png["Architecture du runner"]

L'√©quipe de Polycode est en ce moment m√™me en train de d√©velopper un gestionnaire de machine virtuelle qui g√®rera ces aspects d'isolation et de lancement de machines virtuelle.

=== Enregistrement des runners

Afin de pouvoir contacter les runners pouvant √™tre sur plusieurs machines virtuelles nous aurons besoin d'un register qui gardera en m√©moire l'adresse des diff√©rents services. Nous utiliserons Consul par HashiCorp qui permet de faire de la d√©couverte de service, les runners s'enregistreront aupr√®s de consul et consul nous permettra de les r√©cup√©rer, l'avantage de Consul est que les proxy qu'il g√©n√©re supportent de base la r√©partition de charge, il sera donc plus facile de distribuer les services runners sur plusieurs machines. Le m√™me raisonnement s'applique sur nos autres microservices.

.Sch√©ma issu du site internet de Consul
image::{img}/consul_architecture.svg["Architecture de Consul"]

<<<
== Q7: Comment g√©rer les donn√©es?

=== Organisation des bases de donn√©es

Quand on se pose la question de l'organisation des donn√©es la premi√®re question que l'on peut se poser est "comment vont √™tre associ√©s les services et les bases de donn√©es ?", pour r√©pondre √† cette question on a deux grandes approches: Le pattern "shared database" et le pattern du "Database per service".

La premi√®re aproche consiste √† mettre en place une de base de donn√©es (ou un cluster) dans laquelle tous les services viendraient √©crire et lire. Cette mani√®re d'organiser sa base de donn√©e permet d'avoir des services qui sont ais√©ment capables de faire des jointures si besoin, la source de donn√©e √©tant unique. 

Cependant ce choix de design n'est adapt√© qu'√† des architectures monolithiques, il est m√™me consid√©r√© par beaucoup comme un anti-pattern. En effet la base de donn√©es consistera en un _Single point of failure_ si la base de donn√©es plante, l'enti√®ret√© du syst√®me sera paralys√©. De plus cela entrave le d√©veloppement des services car tous les services seront d√©velopp√©s pour un seul type de base de donn√©es. Ces pour ces raisons que nous rejetons instantan√©ment ce pattern.

.Shared database pattern
image::{img}/shared-database.png["Pattern shared database"]

√Ä l'exact oppos√© nous avons le pattern _database per service_ dans lequel les instances de chaque service ont √† disposition une base de donn√©es d√©di√©, inaccessible par d'autres services. Ce d√©couplage entre les services permet d'√©viter de surcharger une seule base de donn√©es et donc r√©duit les latences de chaque service. De plus cela permet d'avoir une application Polyglotte, c'est √† dire que gr√¢ce √† cette separation des services vis √† vis de leurs donn√©es, nous pourrons avoir des services utilisants diff√©rents SGBD en fonction de nos besoins. 

Au vu des avantages du pattern _database per service_, nous allons l'impl√©menter dans notre architecture, √† la seule diff√©rence que nos services seront reli√©s √† des clusters de base de donn√©es, ce qui permettra de r√©partir la charge et d'avoir des donn√©es coh√©rentes.

.Database per service pattern
image::{img}/database-per-service.png["Pattern database per service"]

=== SGBD utilis√©s

Nos services utiliserons diff√©rents types de base de donn√©es en fonctions de nos services:

* [.underline]#Gestion des utilisateurs :# Relationelle. Cette base de donn√©es stockera les utilisaturs, que leurs adresses email, leurs param√®tres ainsi que les transactions effectu√©es en Polypoints. Nous voulons nous assurer que les donn√©es soient ACID car les informations stock√©es (notament les adresses mails, les mots de passe ou encore les items achet√©s) sont assez importantes pour √©xiger une coh√©rence forte. 

* [.underline]#Edition de modules :# Documentaire. Les modules, composants, validateurs et composants ont √©t√© d√©sign√©s pour √™tre des √©l√©ments centraux et r√©utilisable de Polycode remplissent de nombreuses fonctions en effet ils sont utilis√©s dans le cadre des exercices, des √©valuations et dans les campagnes de test. Cette vari√©t√© implique n√©c√©ssairement des sch√©mas qui vont varier. Les bases de donn√©es documentaires sont adapt√©es √† ce genre de cas de part l'abscence de sch√©ma pr√©cis pr√©d√©fini.

* [.underline]#Gestion de campagne de tests:# Relationelle. Les campagnes de tests sont des structures de donn√©es auquelles sont rattach√©es les candidats ainsi que des tags. Nous souhaitons des donn√©es les plus coh√©rentes car il serait malheureux que des utilisateurs ne soint pas reli√©s √† une campagne √† cause d'un manque de coh√©rence.

[source, yaml]
....
## Campaign
- id: `uuid`
- name: `string`
- description: `string`
- testId: `uuid`
- creatorId: `uuid`

# ...

## Candidate
- id: `uuid`
- campaignId: `uuid`
- userId: `uuid`
- status: `string{Confirmation Pending, Confirmed, Declined, Cancelled, Test Sent, Test Opened, Test In Process, Test Finished}`
- startedAt: `Date`
- email: `string`
- linkCode: `uuid`
- linkExpiration: `Date`
....

Pour les bases de donn√©es relationnelles nous utiliserons PostgresSQL. En effet ce dernier compar√© √† d'autres SGBD s'est impos√© par ses nombreuses fonctionnalit√©s et ses languages support√©s malgr√© le fait qu'elle ne soit pas la plus rapide.
Cependent le r√©el int√©r√™t de postgres c'est sa fiabilit√© quant √† l'√©cx√©cution des transactions. En effet PostgreSQL tient un Write Ahead LOG (WAL), soit des logs √©crits avant les transactions, ce qui permet de les re-√©x√©cuter si la transaction s'arr√™te inopin√©ment comme par exemple dans le cas d'une panne. Ce journal peut √™tre envoy√© √† d'autres instances pour former un cluster, le transfert peut se faire en streaming ou via FTP pour privil√©gier soit respectivement pour une r√©plication asynchone ou une r√©plication synchrone.

Dans un cluster postgres nous avons deux types de noeuds: les noeuds ma√Ætres qui se chargent des op√©rations d'√©criture faisant preuve de source de v√©rit√©, et les noeuds esclave qui eux se contentent de copier les donn√©es des ma√Ætres afin d'√™tre op√©rationnels pour les op√©rations de lecture.

.Exemple de cluster Postgres
image::{img}/pg_cluster.png["Cluster PostgreSQL"]

Pour ce qui est de l'organisation du cluster nous avons deux choix: 

* Avoir plusieurs noeud ma√Ætres, ce qui permet une plus grande disponibilit√© et une bonne tol√©rance aux pannes quand √† l'√©criture des donn√©es en effet si un des noeuds ma√Ætres tombe en panne, un autre peut prendre la rel√®ve. Cependant la pr√©sence de multiple sources de v√©rit√© peut amener √† des conflits qui doivent √™tre r√©solus.

* Avoir un seul noeud ma√Ætre. Cette approche propose l'exact inverse de l'approche multi-ma√Ætre: √† savoir une abscence de conflits mais une moins bonne disponibilit√©.

Nous souhaitons √† tout prix avoir des bases de donn√©es hautement disponibles mais avec les donn√©es les plus coh√©rentes possibles. Nous allons donc r√©pondre au premier besoin avec un cluster multi-ma√Ætre, et au second point en utilisant le streaming du WAL, afin que les donn√©es soient mises √† jour le plus fr√©quemment possible pour √©viter des conflits.


Alternativement, il a √©t√© envisag√© d'utiliser Apache Cassandra, une base de donn√©es orient√©e colonnes, souvent utilis√©e pour rapidement stocker de grands volumes de donn√©es, en effet chaque noeud d'un Ring est capable de contenir juqu'√† plus de 1 Teraoctet de donn√©es et faire √©norm√©ment d'√©critures par seconde. N√©anmoins, au del√† du fait Cassandra n'est pas une base de donn√©es _ACID compliant_ de part l'abscence de transactions et de transactions, il y a aussi une bascence de jointure ce qui implique donc un refactoring de nos donn√©es mais aussi des donn√©es dupliqu√©es pour chacune de nos relations n-aires ce qui √™ut √™tre compliqu√© √† g√©rer. Nous n'avons donc pas gard√© cette solution.


Pour ce qui est des bases de donn√©es orient√©e documents 3 noms sont ressortis pendant mes recherches: CouchDB, CouchBase et MongoDB. Tous deux sont des bases de donn√©es orient√©es document tr√®s similaires mais ont quand m√™me beaucoup de diff√©rences.

CouchDB est un projet de la fondation Apache qui vise √† fournir une base de donn√©es orient√©e document, vou√©e √† √™tre acessible et manipulable via une API REST mais aussi √† √™tre ACID. Malgr√© cet avantage il y a des inconv√©niants majeurs comme le fait que les donn√©es soient stock√©es en format JSON (JavaScript Object Notation) qui est un format lourd, le fait que ce ne soit pas stock√© en m√©moire, l'abscence de transactions la latence observ√©e sur les grands sets de donn√©es. Nous rejeterons donc ce SGBD pour ces raisons.

Pour pallier √† une partie de ces probl√®mes il existe Couchbase, un SGBD cr√©√© par la fusion de CouchOne, une base de donn√©es bas√©e la base de donn√©es orient√©e document couchDB, et de membase une base de donn√©e cl√©-valeur stock√©e en m√©moire. Elle a la particulit√© de stocker ses documents sur disque, mais aussi de placer les plus r√©cents dans la m√©moire RAM.


La solution pour laquelle nous avions opt√©e dans les pr√©c√©dentes versions de Polycode est MongoDB. Il s'agit d'un SGBD orient√© document dont la princiale particularit√© est que le stockage des donn√©es est en BSON, qui un format de donn√©es binaire qui permet de stocker des donn√©es JSON de mani√®re plus compacte.

MongoDB et couchbase ayant beaucoup de points communs nous allons les comparer dans le tableau suivant:

[cols="h,2,2"]
|===
||MongoDB|CouchBase

|Indexage
|Indexage par arbre binaire. Temps moyen `_O(log n)_`, temps dans le pire des cas `_O(log n)_`
|Indexage par skip list. Temps moyen `_O(log n)_`, temps dans le pire des cas `_O(n)_`

|Performances
|Performances constantes peut importe la taille du cluster
|Performances limit√©es dans un petit cluster mais augmentent rapidement avec la taille du cluster

|Stockage des donn√©es
|Stockage sur disuqe avec le format BSON
|Les documents les plus r√©cents ont droit √† une copie en m√©moire, les documents sont stock√©s dans des _virtuals Buckets_ qui sont copi√©s sur plusieurs noeuds d'un cluster
|===

.Comparaison entre CouchBase MongoDB et Cassandra
image::{img}/comparison_CB_Mongo.png["Comparaison entre CouchBase MongoDB et Cassandra"]

Concr√®tement couchbase est plus appropri√©e dans des environnements de grande taille, tandis que MongoDB est plus Polyvalent. Nous avons donc opt√© pour MongoDB de part cette polyvalence.

<<<
== Q8: Comment ajouter une application mobile dans le syst√®me

=== Fonctionalit√©s et mockup visuels

Dans le cadre d'une application mobile int√©gr√©e √† Polycode, nous souhaiterions proposer une exp√©rience la plus proche possible que ce que l'utilisateur peut avoir sur un ordinateur, tout en l'adaptant le plus possible au support Android.

C'est autour de cette ligne directrice que nous avons d√©fini les fonctionnalit√©s que nous souhaiterions impl√©menter dans notre application mobile.

Premi√®rement des fonctionnalit√©s hors ligne seront propos√©es: 

* Les informations de l'utilisateur notament le nom d'utilisateur, ses adresses email, son nombre de polypoint, ses √©quipes et son rang seront stock√©es en local et synchronis√©es avec le serveur lorsqu'une connexion internet sera disponible. 
* √Ä chaque connexion √† internet l'application va garder en cache une partie des modules et des contenus charg√©s afin de pouvoir les lire et de les compl√©ter hors ligne.
* Le code √©crit dans un √©diteur de code par l'utilisateur sera stock√© en local, afin d'√™tre modifi√© m√™me hors ligne.
* Un utilisateur pourra soumettre du code et des r√©ponses aux exercices m√™me hors ligne, l'application s'occupera d'envoyer les donn√©es lorsqu'une connexion internet sera disponible et notiefira l'utilisateur de ses r√©sultats.

Comme sous entendu ci-dessus nous autorisons l'utilisateur √† r√©pondre aux contenus et nottaments ceux de type √©diteur de code sur t√©l√©phone. Pour faciliter la saisie de code, il sera mis en place un √©diteur de code avec coloration syntaxique, autocompl√©tion ainsi qu'une barre horizontale plac√©e au dessus du clavier de l'utilisateur, sur laquelle sera plac√©e des characat√®res sp√©ciaux fr√©quemment utilis√©s dans le language de programmation contenu dans l'√©diteur. En cliquant sur ses caract√®res sp√©ciaux, ils seront automatiquement ajout√©s √† la position du curseur dans l'√©diteur pour que l'utilisateur n'aie pas a naviguer dans les symboles de son clavier, tout comme le shell pour Android Termux.

.Editeur de code sans focus du clavier
image:{imgcode}/editor.png["Editeur de code sans focus du clavier"]


.Editeur de code avec focus du clavier
image:{imgcode}/writing.png["Editeur de code avec focus du clavier"]

Cependant cette fonctionnalit√© ne sera pas disponible pour des questions de lisibilit√© et de confort d'utilisation. Elle sera donc d√©sactiv√©e si l'application mobile juge que votre √©cran est trop petit, cet inconfort pouvant √™tre consid√©r√© comme un d√©sanvantage compar√© √† un ordinateur, les utilisateurs  ne pourront pas participer aux campagnes de tests via l'application mobile par soucis d'√©galit√©.
Ce probl√®me de visibilit√© nous contraint aussi √† restreindre les op√©ration CRUD de module et de contenu ainsi que d'emp√™cher l'utilisation des outils d'administration.


.Message d'erreur en cas d'√©cran trop petit
image:{imgcode}/too_small.png["Message d'erreur en cas d'√©cran trop petit"]

.Message d'erreur en cas d'acc√®s √† un test
image:{imgcode}/assessment.png["Message d'erreur en cas d'acc√®s √† un test"]

Un mockup UI a √©t√© r√©alis√© avec Figma afin de visualiser l'application mobile dans son ensemple. Un aper√ßu est disponible √† {figmalink}[cette adresse], vous pouvez naviguer dans le mockup gr√¢ce √† {navlink}[ce lien].

=== Flows de fonctionnement

Il y a 5 flows principaux dans l'application mobile:

* {navlink}[L'authentification et la cr√©ation de compte]
* {profile-flow}[La gestion de compte]
* {module-flow}[La navigation dans les modules et les contenus]

* {team-flow}[La gestion d'√©quipe]
* {search-flow}[Recherche de contenus et modules]

Nous pourrions d√©finirs deux flows suppl√©mentaires, du au fait que nous pourrions ouvrir l'application √† partir d'un lien:

* {404-flow}[Ouverture d'un lien n'xistant pas (erreur 404)]
* {assessment-flow}[Ouverture d'un lien r√©f√©rencant un test qui pour rappel est interdit aux utilisateurs de l'application mobile]

=== API

L'application mobile comuniquera avec notre architecture gr√¢ce √† une API Rest. Nous aurions pu privil√©gier GraphQL, un langage de requ√™te orient√© client, dans lequel le client formule aupr√®s d'un serveur la forme de sa r√©ponse. Notre application mobile n'√©tant pas orient√© autour de la consommation de donn√©es, mais plut√¥t de l'envoi de donn√©es, nous avons pr√©f√©r√© utiliser une API Rest, de plus le choix de l'API REST permet de mettre en cache les r√©ponses gr√¢ce √† l'en-t√™te HTTP ``Headers``. 

Comme vous pourrez le voir sur la page Swagger de notre API <<api_swagger>> que l'API consiste en l'API de la webapp priv√©e de Routes ``PATCH``, ``PUT`` et ``DELETE`` ces derni√®res √©tant des routes modifiant ou supprimant des ressources.

ifdef::backend-html5,backend-docbook5[]
Voici un aper√ßu de notre API Rest:

++++
include::{swagger-file}["Swagger"]
++++
endif::[]


=== Authentification

// auth code flow avec PKCE 


<<<
== Q9: Comment g√©rer les probl√©matiques de s√©curit√©

=== S√©curisation du r√©seau

La premi√®re des choses √† faire dans le cadre de la s√©curisation du r√©seau est de mettre en place un certificat TLS aussi bien pour s√©curiser le traffic venant des utilisateurs mais aussi pour s√©curiser le traffic √† l'int√©rieur de notre architecture, car si un acteur malveillant parvient √† se placer dans notre architecture il pourrait intercepter des donn√©es sensibles, ou ce que l'on appelle plus commun√©ment une attaque _man in the middle_.

Cependant pour assurrer une meilleure s√©curit√© nous pouvons impl√©menter un mTLS (multiple TLS), CloudFlare d√©finit le mTLS comme suit dans un article <<cloudflare>>:

[quote,Cloudflare,Qu'est-ce que le TLS mutuel (mTLS) ?]
Mutual TLS, ou mTLS en abr√©g√©, est une m√©thode d'authentification mutuelle. mTLS garantit que les parties √† chaque extr√©mit√© d'une connexion r√©seau sont bien celles qu'elles pr√©tendent √™tre en v√©rifiant qu'elles poss√®dent toutes deux la bonne cl√© priv√©e. Les informations contenues dans leurs certificats TLS respectifs fournissent une v√©rification suppl√©mentaire.
mTLS est souvent utilis√© dans un cadre de s√©curit√© Zero Trust pour v√©rifier les utilisateurs, les appareils et les serveurs au sein d'une organisation. Il peut √©galement contribuer √† s√©curiser les API.

.Sch√©matisation de mTLS
image::{img}/mTLS.png["Sch√©matisation de mTLS"]

Selon ce m√™me article <<cloudflare>>, le mTLS r√©pond √† 5 types d'attaque:

* Les attaques _man in the middle_.
* Les usurpations d'identit√©.
* Les attaques par brute force, qui n√©c√©ssiteront encore plus d'essais.
* Le phishing, un attaquant √† besoin d'une cl√© priv√©e et d'un certificat.
* Requ√™tes venant d'API malveillantes.

En plus de chiffrer nos donn√©es envoy√©es sur le r√©seau, il faut se charger de v√©rifier l'int√©grit√© des donn√©es si jamais la protection par mTLS est compromise. Pour cela nous allons utiliser des JSON Web Tokens (JWT) qui sont des tokens contenant les donn√©es envoy√©es ainsi qu'une signature permettant de v√©rifier l'int√©grit√© des donn√©es qui consiste en un hachage des donn√©es et d'une valeur secr√®te.

image::{img}/JWT.png["Sch√©matisation de JWT"]

M√™me si un acteur malveillant venait √† modifier les donn√©es de nos requ√™tes (en rouge et rose ci dessus) et √† les envoyer, la signature (en bleu) ne serait pas correcte car l'acteur ne connait pas la valeur secr√®te, n√©cessaire au calcul de la signature. 

=== Gestion des secrets

Dans notre applications nous aurons de nombreuses variables que nous souhaiterons garder secr√®tes, comme par exemple les secrets JWT ou encore les identifiantrs pour nos bases de donn√©es, pour cela nous allons utiliser un outil de gestion de secrets comme Vault.  

// üöß WIP 

=== Gestions des volumes

=== Autres protections

==== Protection contre les attaques CSRF


==== Protection contre les attaques DDoS


Nous avons impl√©ment√© toutes ces protections dans un POC que vous pourrez retrouver sur GitHub <<poc_q9>>.


<<<
== Q10: Comment int√©grer les applications UI?

<<<
[bibliography]
== Bibliographie/Webographie/Liens
* [[[poc_q3_lp]]] https://gitlab.polytech.umontpellier.fr/yann.pomie/poc3-long-polling
* [[[poc_q3_ws]]] https://gitlab.polytech.umontpellier.fr/yann.pomie/poc3-ws
* [[[poc_q3_http]]] https://gitlab.polytech.umontpellier.fr/yann.pomie/poc3-http-async
* [[[rfc6202]]] https://www.rfc-editor.org/rfc/rfc6202#section-2.2
* [[[api_swagger]]] {swagger-url}
* [[[cloudflare]]] https://www.cloudflare.com/fr-fr/learning/access-management/what-is-mutual-tls/
* [[[poc_q9]]] https://github.com/WoodenMaiden/poc9_polycode